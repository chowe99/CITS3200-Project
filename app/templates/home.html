<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Query and Plot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <div id="message-area"></div>
    <div id="success-popup" class="popup">
      <div class="popup-content">
        <span class="close-button">&times;</span>
        <div id="popup-messages" style="max-height: 300px; overflow-y: auto;"></div>
      </div>
    </div>
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <ul class="flashes">
      {% for message in messages %}
      <li>{{ message }}</li>
      {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}
    <h1>Soil Database Tool</h1>

    <h2>Upload Excel File</h2>
    <form id="upload-form" method="post" enctype="multipart/form-data" action="/upload">
      <label for="excel-file">Select Excel Files:</label>
      <input type="file" id="excel-file" name="excel_files" accept=".xlsx" multiple required><br><br>

      <label for="password">Encryption Password (optional):</label>
      <input type="password" id="encrypt_password" name="encrypt_password" placeholder="Enter password to encrypt data"><br><br>

      <button type="submit">Upload and Process</button>
    </form>

    <form id="filter-form">
      <table>
        <thead>
          <tr>
            <th rowspan="2"><h2>Select Spreadsheets</h2></th>
            <th colspan="2"><h2>Select Instance Filters</h2></th>
            <th rowspan="2"><h2>Select Plot</h2></th>
          </tr>
          <tr>
            <th>Instance</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <!-- Select Spreadsheets -->
            <td>
              <div id="spreadsheet-selection">
                <h3>Preset Spreadsheets:</h3>
                <div>
                  <input type="radio" id="preset-public" name="preset_selection" value="Public" checked>
                  <label for="preset-public">Public</label><br>

                  <input type="radio" id="preset-private" name="preset_selection" value="Private">
                  <label for="preset-private">Private</label><br>

                  <input type="radio" id="preset-public-private" name="preset_selection" value="Public+Private">
                  <label for="preset-public-private">Public + Private</label><br>

                  <input type="radio" id="preset-custom" name="preset_selection" value="Custom">
                  <label for="preset-custom">Custom</label>
                </div>

                <!-- Custom Spreadsheet Selection -->
                <div id="custom-selection" style="display: none; margin-top: 10px;">
                  <h3>Custom Selection:</h3>
                  <div id="custom-table-checkboxes">
                    {% for table in tables %}
                      <div class="table-row">
                        <input type="checkbox" id="custom-table-{{ loop.index }}" name="custom_tables[]" value="{{ table.spreadsheet_name }}">
                        <label for="custom-table-{{ loop.index }}" class="table-label">{{ table.spreadsheet_name }}</label><br>
                      </div>
                    {% endfor %}
                  </div>
                  <br>
                  <!-- Button to Clear Custom Selections -->
                  <button type="button" id="clear-custom" class="clear-button">Clear Custom Selections</button>
                </div>
              </div>
            </td>

            <!-- Select Instance Filters -->
            <td colspan="2">
              <div id="instance-selection">
                <table>
                  <tbody>
                    {% for key, values in instances.items() %}
                    <tr>
                      <td>
                        <label>{{ key.capitalize() }}</label>
                      </td>
                      <td>
                        <div class="value-checklist">
                          {% for value in values %}
                          <input type="checkbox" id="{{ key }}_{{ value }}" name="{{ key }}_values" value="{{ value }}">
                          <label for="{{ key }}_{{ value }}">{{ value }}</label><br>
                          {% endfor %}
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </td>

            <!-- Select Plot Options -->
            <td>
              <div id="plot-options">
                <h3>Preset Plot Options:</h3>
                <select name="preset-options" id="preset-options">
                  <option value="None">None</option>
                  <option value="non_calc_1">p', q, induced PWP vs axial strain</option>
                  <option value="non_calc_2">q vs p'</option>
                  <option value="non_calc_3">Vol strain vs axial strain</option>
                  <option value="calc_1">e vs log(p')</option>
                  <option value="calc_2">q/p' vs axial strain</option>
                  <option value="calc_3">qmax/p' vs p'</option>
                </select>

                <!-- Custom Graph Option -->
                <div style="margin-top: 10px;">
                  <input type="checkbox" id="custom-graph" name="custom_graph">
                  <label for="custom-graph">Custom Graph</label>
                </div>

                <!-- Custom X/Y Axis selection (hidden by default) -->
                <div id="custom-axis-selection" style="display: none; margin-top: 10px;">
                  <div>
                    <h3>Select X-Axis:</h3>
                    <select name="x_axis" id="x_axis">
                      {% for column in x_axis_options %}
                      <option value="{{ column }}">{{ column.replace('_', ' ').capitalize() }}</option>
                      {% endfor %}
                    </select>
                    <p>X-axis is only added if preset plot options is set to 'None'</p>
                  </div>

                  <div>
                    <h3>Select Y-Axis (Select multiple columns with checkboxes):</h3>
                    <div id="y-axis-container">
                      {% for column in y_axis_options %}
                      {% if column == 'p' %}
                      <input type="checkbox" name="y_axis" value="{{ column }}"> p'<br>
                      {% else %}
                      <input type="checkbox" name="y_axis" value="{{ column }}"> {{ column.replace('_', ' ').capitalize() }}<br>
                      {% endif %}
                      {% endfor %}
                    </div>
                    <p>Y-axes can be added to preset plots options.</p>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Decryption Password -->
      <div style="margin-top: 20px;">
        <label for="decrypt_password">Decryption Password:</label>
        <input type="password" id="decrypt_password" name="decrypt_password"><br><br>
      </div>

      <!-- Generate Plot Button -->
      <div>
        <button type="submit">Generate Plot</button>
      </div>
    </form>

    <!-- Container to display the plot -->
    <h2>Generated Plot:</h2>
    <div id="plot-message-area"></div>

    <div id="file-passing"></div>
    <button id="fullscreen-button" onclick="toggleFullScreen()">Full Screen</button>

    <div id="plot-container"></div>

    <!-- Link to external JavaScript file -->
    <script src="{{ url_for('static', filename='scripts.js') }}"></script>
    <!-- Include Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  </body>
</html>

